# F4.9 参数提取函数关系

本节聚焦尺寸参数计算阶段（F4.9），梳理核心函数及其依赖关系，便于后续调整参数提取逻辑。

## 数据入口：`finalize_pairs`
- 位置：`package_core/PackageExtract/common_pipeline.py`
- 作用：整合 OCR 文本、标尺长度与尺寸线副本，调用 `get_better_data_2` 过滤/补全配对，输出清洗后的 OCR 列表与尺寸线集（`yolox_pairs_*`）。
- 依赖字段：
  - OCR 数据：`top/bottom/side/detailed_ocr_data`。
  - 引线补齐结果：`*_yolox_pairs_length`。
  - 尺寸线副本：`*_yolox_pairs_copy`。
- 产物：更新的 OCR 数据与 `yolox_pairs_top/bottom/side/detailed`，供参数推断使用。

## 主计算：`compute_BGA_parameters`
- 位置：`package_core/PackageExtract/common_pipeline.py`
- 输入：`finalize_pairs` 产出的 OCR 与尺寸线结果，以及封装边框 `top/bottom_border`。
- 核心步骤：
  1. **PIN 阵列尺寸**：`get_serial(top_serial_numbers_data, bottom_serial_numbers_data)` 根据序号框差值统计推断 `nx/ny`。
  2. **主体长宽估计**：`get_body(...)` 将尺寸线引线与实体边框对齐，寻找符合误差的长宽候选，必要时互补 top/bottom 结果。
  3. **候选组装与筛选**：
     - `get_BGA_parameter_list(...)` 把各视图 OCR 归入参数槽位（D/E/A/A1/e/b/θ/L 等），并记录候选数量。
     - `resort_parameter_list_2(...)` 若某参数只有唯一候选则标记确定，同时从其他参数候选中剔除重复值，循环收敛。
     - `get_QFP_high(...)`、`get_QFP_pitch(...)` 在候选数量>1时用于专门筛选高度与引脚间距候选。
  4. **返回**：参数列表与 `nx/ny`。

## 结果封装：`get_BGA_parameter_data`
- 位置：`package_core/PackageExtract/function_tool.py`
- 作用：将 `compute_BGA_parameters` 返回的参数结构映射到固定长度的 BGA 参数表（19 行），当前填充 PIN 间距、实体尺寸、高度等关键字段，供 `run_f4_pipeline` 直接返回。
- 行列计数 `nx/ny` 目前未写入表格，但可在后续扩展中使用。

## 新增：各封装独立的“填参”封装函数
- 位置：`package_core/PackageExtract/parameter_fillers.py`
- 作用：在不改动原流程的前提下，为 BGA/QFP/QFN/SOP/SON 提供专属的参数填充入口（形态与 `get_BGA_parameter_data` 保持一致）。可单独导入使用，便于后续按封装定制输出表结构或测试替代实现。
- 函数入口：
  - `fill_bga_parameters(...)`
  - `fill_qfp_parameters(...)`
  - `fill_qfn_parameters(...)`
  - `fill_sop_parameters(...)`
  - `fill_son_parameters(...)`
  - `fill_parameters_by_package(package_type, parameter_candidates, nx, ny)`：按封装类型调度上述函数。

## 依赖脉络总结
1. `finalize_pairs` 清洗配对结果，确保尺寸线/OCR 数据一致性。
2. `compute_BGA_parameters` 调用 `get_serial` → `get_body` → `get_BGA_parameter_list` →（可选）`get_QFP_high`/`get_QFP_pitch`/`resort_parameter_list_2` 完成参数推导。
3. `get_BGA_parameter_data` 将推导结果转换为最终参数列表。

## 细节说明：`compute_BGA_parameters` 与 `get_BGA_parameter_list`

### `compute_BGA_parameters` 的原理
- 入口数据来自 `finalize_pairs`，其输出已包含整理好的 OCR 标注（`*_ocr_data`）、配对尺寸线（`yolox_pairs_*`）以及边框信息。
- 首先调用 `get_serial`，基于 `top_serial_numbers_data` / `bottom_serial_numbers_data` 统计 PIN 序号差异，推断行列数 `nx/ny`。
- 随后调用 `get_body`，使用标尺线引线与封装边框的几何关系推断封装主体的长宽（`body_x/body_y`），这一步用于限定 D/D1/E/E1 的候选范围。
- 最后调用 `get_BGA_parameter_list` 对四个视图的 OCR 候选进行分桶，得到每个参数的候选集合，再结合：
  - `resort_parameter_list_2`：如果某参数只有唯一候选，则锁定该候选并从其他参数中剔除同值。
  - `get_QFP_high`：在高度类参数中挑选高置信候选。
  - `get_QFP_pitch`：结合 `nx/ny` 与主体尺寸筛选 pitch 候选。
- 返回值是参数候选列表与 `nx/ny`，供 `get_BGA_parameter_data` 写入最终表格。

### `get_BGA_parameter_list` 的原理
- 该函数以 `top_ocr_data / bottom_ocr_data / side_ocr_data / detailed_ocr_data` 作为输入，并预先定义各参数的合法范围（如 D/E/A/A1/e/b/θ/L 等）。
- 对每个视图的 OCR 候选，依据 `max_medium_min` 落入的数值区间，将标注加入对应参数的 `maybe_data`。
- 特殊语义依赖字段：
  - `Absolutely == 'angle'` 的标注被归类到角度参数候选。
  - `key_info` 中含 `Φ` 或 `Absolutely == 'pin_diameter'` 的标注会被归类到直径类参数候选。
- 输出结构为列表，每个元素包含 `parameter_name`、`maybe_data`、`maybe_data_num` 等字段，供后续筛选与参数落表使用。
